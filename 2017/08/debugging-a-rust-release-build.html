<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
      <title>Debugging a Race Condition in a Release Target</title>
    

    <link rel="stylesheet" href="/assets/css/normalize.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">

  </head>
  <body>
    <div class="c-content">
      <header class="c-blog-name">
        <h2 class="c-blog-name__heading"><a href="/">Boxofrox Blog</a></h2>
      </header>
      <main class="c-main">
        
          <article>
  <h1 class="c-post__title">Debugging a Race Condition in a Release Target <span class="c-post__date">2017-08-08</span></h1>
  <section>
    <p>Back in June, while working on a <a href="https://rustlang.org">Rust</a> project, I had
the unfortunate opportunity to stumble upon a very obscure bug in a dependency.
The bug didn't occur in the debug build target at all, only the release target.
And even then, the bug didn't present itself 100%.  It hovered between 10-50%.</p>
<p>I'll cover the obstacles I encountered, the tools I used, and how I applied
them.  This story involves Rust stable 1.18 and nightly 1.19 along with GDB 8.0
and reverse debugger (<em>rr</em>) 4.5.0.</p>
<h2>What Am I Developing?</h2>
<p>A customer of mine uses open-source software to manage their inventory and
organize the inventory with an unorthodox method. Searching with MySQL queries
against multiple fields scattered across a few tables has slowed to a crawl
(10-60 seconds) as the size of their inventory grew.  On top of that, the
search results lacked any scoring and many results were irrelevant.</p>
<p>So I decided to solve this problem--once and for all!!... perhaps--by writing a
custom fuzzy search daemon that will periodically fetch the searchable data
from the database and cache it, then allow the inventory software to exchange
search terms for a much shorter list of relevant search results.</p>
<p>I chose Rust to program the daemon, and in anticipation for orchestrating the
many tasks that will be incorporated--most of which are input/output (IO)
bound--I settled on using <a href="https://crates.io/crates/tokio"><em>tokio</em></a> async
framework along with the <a href="https://crates.io/crates/mysql_async"><em>mysql_async</em></a>
crate which provides a database API utilizing <em>tokio</em>.</p>
<p>I created an initial proof of concept (POC) by rewriting my <a href="https://github.com/jhawthorn/fzy">favorite fuzzy
search program</a> with a scoring algorithm
relevant to my needs.  Search data was exported from the customer's database
and placed in a CSV file to avoid the complexity of database programming at
this stage.  Testing the fuzzy search showed it performed abysmally with the
debug target (upward of 5-10 seconds to match and score against 100k
candidates), while the release target operated between 11-30 milliseconds.
Also promising is that the search data used with this POC only consumed 2.5 MB.</p>
<h2>The Symptom</h2>
<p>How I found this bug is a story itself, and demonstrates why monopolizing
testing against a debug target may postpone disaster until you near the end of a
project.  I prefer to identify bugs as early as possible via spot testing so
troubleshooting has less code to suspect.</p>
<p>As I add new features (e.g. config file, DB support, HTTP interface, endpoints,
etc), I'll test mostly against the debug target, and before moving on to
another feature, I'll check the release target to ensure performance hasn't
dropped significantly.</p>
<p>It was during this release target test for the database addition that
<em>mysql_async</em> first reported a <code>PacketOutOfOrder</code> error.  I retested a dozen
times or so and found the error occurred frequently, but not every time.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">▶ DSN=mysql://testbot:testbot@192.168.0.162/fake_data RUST_LOG=bug_test_01=debug ./target/release/bug-test-01
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:bug_test_01: running
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">thread &#39;main&#39; panicked at &#39;error resolving future: Error(PacketOutOfOrder, State { next_error: None, backtrace: None })&#39;, src/libcore/result.rs:859
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">note: Run with `RUST_BACKTRACE=1` for a backtrace.
</span></pre>
<p>This is a problem.  A single query will pull megabytes of data from the MySQL
server and cache that information to facilitate fast searches.  The application
can't frequently fail to pull megabytes of data and retry without putting
unwanted load on the network and database.  I must understand why the
application runs flawlessly on the slow debug target, but not on the blazingly
fast release target.</p>
<p>The game is afoot.</p>
<h2>First Steps</h2>
<p>A long time ago, I eschewed Windows in favor of Linux.  Over the years, I
discarded integrated development environments (IDEs) and their difficult build
systems, opinionated project layouts, <em>*cough*</em> and lack of Vim keybindings
<em>*cough*</em>.  I've much enjoyed the command-line and its versatility and the
development tools that live there.</p>
<p>Except the Gnu debugger (GDB).  It has been my Kryptonite when debugging
programs and it's typically a last resort.  I just haven't paid the technical
debt to master it, or for the matter use it proficiently.</p>
<p>So my first-pick method for determining what my program <em>is</em> doing versus what
it <em>should</em> be doing is print statements.  Since the error originated from
<em>mysql_async</em>, I cloned the crate locally and modified it to print the MySQL
packet sequence ID it found before the error.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">diff --git a/src/conn/futures/read_packet.rs b/src/conn/futures/read_packet.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">index 33719f0..ea5fe58 100644
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">---</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> a/src/conn/futures/read_packet.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">+++</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> b/src/conn/futures/read_packet.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">@@</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-46,6 +46,7</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">@@</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> impl Future for ReadPacket {
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">let packet = {
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">let conn = self.conn.as_mut().unwrap();
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">if conn.seq_id != seq_id {
</span><span style="background-color:#2d2d2d;color:#99cc99;">+</span><span style="background-color:#2d2d2d;color:#99cc99;">                                debug!(&quot;packet out of order.  found {}, expected {}&quot;, seq_id, conn.seq_id);
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">return Err(ErrorKind::PacketOutOfOrder.into());
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">conn.stream = Some(stream);
</span></pre>
<p>The output from a test run confirmed the sequence did break (expected 98, found
221), and after a few more test runs, I found the error never occurs at the
same MySQL packet.  Is my program receiving garbage from my database, or is it
buggy?</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">▶ DSN=mysql://testbot:testbot@192.168.0.162/fake_data RUST_LOG=bug_test_01=debug,mysql_async=debug ./target/release/bug-test-01
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:bug_test_01: running
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...connection handshake and query submission...
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 1
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 2
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 3
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 4
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 5
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 6
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 7
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 8
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 9
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 10
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...sequence of repeating ids from 0 to 255...
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 217
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 218
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 219
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 220
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 221
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 98
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::conn::futures::read_packet: packet out of order.  found 98, expected 221
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">thread &#39;main&#39; panicked at &#39;error resolving future: Error(PacketOutOfOrder, State { next_error: None, backtrace: None })&#39;, src/libcore/result.rs:859
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">note: Run with `RUST_BACKTRACE=1` for a backtrace.
</span></pre>
<p>I previously used my MySQL 5.5 database server extensively for a variety of
tests in the past without issue, so I'm not inclined to suspect it suddenly
broke.  But I don't like uncertainty hovering over my shoulder when I'm trying
to troubleshoot.  It has a tendency to accumulate.  Besides, a quick network
packet analysis with <a href="https://www.wireshark.org">Wireshark</a> should confirm
whether the problem is in my application or beyond my network interface card
(NIC).  Yep.  Just a quick analysis....</p>
<p>Turns out Wireshark has nifty dissectors that will parse protocols within
protocols.  It has one for MySQL!  And it found a malformed MySQL packet!  Whew,
am I glad the cause isn't some random intermittent behavior in my program,
because I wasn't looking forward to that bug hunt at all.</p>
<div class="figure">
<p><img src="/assets/images/2017-debug-rust-release-target/wireshark-malformed-packet.png" alt="wireshark malformed packet" /></p>
</div>
<p>I've come to learn that a thorough attention to detail is essential to
troubleshoot productively.  Always look at your results from different angles
and verify they are all in accord.</p>
<p>So back to Wireshark I go.  I should be able to cross reference the last
sequence ID from my print statements against the Wireshark packet capture.  The
packet prior to the malformed packet has a sequence ID of 193 while my print
statements claim it parsed sequence ID 101 before finding 52.  I also get
malformed MySQL packets in Wireshark when the test run succeeds.  This is &quot;no
bueno&quot;.  So much for quick.  Jinxed again.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;"># Ouput corresponding to Wireshark capture screenshot.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">▶ DSN=mysql://testbot:testbot@192.168.0.162/fake_data RUST_LOG=bug_test_01=debug,mysql_async=debug ./target/release/bug-test-01
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 100
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 101
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 52
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::conn::futures::read_packet: packet out of order.  found 52, expected 102
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">thread &#39;main&#39; panicked at &#39;error resolving future: Error(PacketOutOfOrder, State { next_error: None, backtrace: None })&#39;, src/libcore/result.rs:859
</span></pre>
<p>At this point in my story, I took a long detour to debug Wireshark's MySQL
dissector.  I won't go into the details.  I reported the
<a href="https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=13754">bug</a>, found a
work-around, recompiled Wireshark with a patch, and was back in business.  No
more malformed MySQL packets.</p>
<p>Afterwards, I captured all the MySQL packets until my program reset the TCP
connection to the database.  Wireshark shows all the sequence IDs are in order
now...  repeatedly.  I think it's safe to say my network hardware is functioning
properly along with the database.  But for good measure, I tested against a
spare MariaDB 10.1.21 database, and the application still suffers from
<code>PacketOutOfOrder</code>.</p>
<p>Note that this entire time I reran a single SQL query against one dataset,
so every query execution should transfer identical data from the database.</p>
<p>At this point, my application fails at random points while parsing the SQL
packets.  I'm certain the failure occurs on the same instruction[s], just at a
different iteration of some loop executing that instruction.  I could switch to
a debugger and stop at this random point with a breakpoint on the code that
noticed the mismatched sequence ID, but there's a couple problems with heading
in this direction now:</p>
<ol>
<li>
<p>I have to backtrack from this random point.  I'm not familiar with GDB's
reverse debugging (running the program backwards), so I'd rather not rely
on it at this point.  Without reverse debugging, I need the cause of the
problem to be in the program stack when I hit the breakpoint.  Since I'm
using futures to write asynchronous code, there's a good chance the cause
is no longer on the program stack.</p>
</li>
<li>
<p>I'm debugging an optimized release target.  The optimizations can prevent
GDB from accessing variables (i.e. <code>print var</code>).  They also reorder
instructions and program follows a different order of execution than the
source code presents.</p>
</li>
<li>
<p>The release target has no debugging information.  This prevents GDB from
matching the assembly code to my source code.  Later, I found that Rust can
build release targets with debugging information.  Just add the following to
your <code>Cargo.toml</code> [<a href="http://doc.crates.io/manifest.html#the-profile-sections">3</a>].</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">[profile.release]
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">debug = true
</span></pre></li>
</ol>
<p>Let's try to get ahead of that point in the program when it runs awry.</p>
<h2>What is the MySQL Parser Doing?</h2>
<p>The <a href="https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_packets.html">MySQL protocol</a> starts out rather simple.  A four-byte
header holds a three-byte length and a one-byte sequence ID.  The header is
followed by <code>length</code> bytes of data.  The data must be parsed at some point, but
I can ignore that in this case.  The data contains rows of the result set for
the SELECT query I run.  At the point my application fails, the data section
does not influence parsing the MySQL packets.</p>
<p>I added some extra print statements to <em>mysql_async</em>'s code that parsed the
network data into MySQL packets give me a brief play-by-play description of its
process to answer questions like:</p>
<ol>
<li>When does it start on a new packet?</li>
<li>When is it waiting on bytes for the header?</li>
<li>When does it have the header and what values did it find?</li>
<li>When does it get the data?</li>
</ol>
<p>With three, maybe four, print statements the error disappears.  Remove
those print statements, the error returns.  Add them, the error vanishes.  This
bug appears to be a race condition.  Those print statements delay the parsing
loop just long enough that the bug cannot manifest itself.  This severely
hampers my ability to generate clues.</p>
<p>Using one or two print statements to collect information isn't effective when
the bug presents at random points in the execution path.  Stepping forward
through the application with GDB will certainly delay the execution and prevent
the race condition from manifesting.  I wasn't sure sure how to debug this
further, so I asked for help.</p>
<h2>A Short, Self Contained, Correct Example</h2>
<p>Asking for programming/debugging advice is fraught with peril.  Provide too few
details, and the person trying to help must fill in the blanks using their
imagination or ask 20+ questions.  The former leads to a thread of confusion and
irrelevant solutions to similar-but-different problems.  The latter can quickly
cascade into a waste of everyone's time.  It helps to imagine someone else is
asking you to help solve the problem, and consider what information you would
need from them.</p>
<p>On the other, hand providing too much information can make the problem difficult
to understand or identify.  The wise sages of the internet love nothing more
than to impart the correct knowledge with the least fuss.</p>
<p>To this end, the short, self contained, correct example
(<a href="http://sscce.org">SSCCE</a>) is a terrific tool that demonstrates the problem,
and allows intrepid programmers to fully understand the task at hand; find a
specific, pertinent solution; and test their solution works before submission.</p>
<p>It's also often the case that in generating an SSCCE (or a very detailed
question), I stumble upon the answer myself before any question is presented.
Do not underestimate the utility of this exercise, no matter how tedious.</p>
<p>One additional benefit of an SSCCE is that it's small and quicker to compile
than a large application.  When you're poking and prodding the source code to
see what effect that has, short compile times matter.</p>
<p>By the time I post my <a href="https://github.com/boxofrox/sscce-future-is-buggy-01">SSCCE on
github</a>, I stripped away
all my application code and what is left is a <em>how to use</em> example from the
<em>mysql_async</em> README.  My code is no longer suspect.  But how far down my software
stack do I have to go to chase this bug?</p>
<h2>Presenting the Reverse Debugger</h2>
<p>On the <a href="https://users.rust-lang.org/t/debugging-advice-for-race-condition-in-database-access-using-futures-and-mysql-async-crates/11201?u=boxofrox">Rust user forum</a>, @inejge recommended I try
<a href="http://rr-project.org/"><em>rr</em></a>.  It's a nifty bit of software that records the
traffic between your program and the outside world by intercepting syscalls.
<em>rr</em> then integrates with GDB to allow you to replay a recording (henceforth
referred to as trace) in forward or reverse.  There's a chance <em>rr</em> may add too
much overhead to my application and prevent the race condition, but this will be
fantastic if it works.</p>
<p>After installing <em>rr</em>, creating a trace is simply <code>rr record &lt;program&gt;</code>.  It
took a few tries, but I managed to capture a trace with the <code>PacketOutOrder</code>
error!</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;"># Ouput corresponding to Wireshark capture screenshot.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">▶ DSN=mysql://testbot:testbot@192.168.0.162/fake_data RUST_LOG=bug_test_01=debug,mysql_async=debug rr record ./target/release/bug-test-01
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 255
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 0
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 1
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 2
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 3
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 101
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::conn::futures::read_packet: packet out of order.  found 101, expected 3
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">thread &#39;main&#39; panicked at &#39;error resolving future: Error(PacketOutOfOrder, State { next_error: None, backtrace: None })&#39;, src/libcore/result.rs:859
</span></pre>
<p>I still wanted to get ahead of the error before I dive into GDB.  So, after
trying one print statement in a few spots, I settled on this one.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">diff --git a/src/io/mod.rs b/src/io/mod.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">index 05d7b8b..c55c75c 100644
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">---</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> a/src/io/mod.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">+++</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> b/src/io/mod.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">@@</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-146,6 +146,7</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">@@</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> impl stream::Stream for Stream {
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">new_packet
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">},
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::Incomplete(mut new_packet, needed) =&gt; {
</span><span style="background-color:#2d2d2d;color:#99cc99;">+</span><span style="background-color:#2d2d2d;color:#99cc99;">                debug!(&quot;data needs {} bytes&quot;, needed);
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">let buf_handle = self.buf.as_mut().unwrap();
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">let buf_len = buf_handle.len();
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">for byte in buf_handle.drain(..cmp::min(needed, buf_len)) {
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">diff --git a/src/proto.rs b/src/proto.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">index 109beac..b0321a0 100644
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">---</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> a/src/proto.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">+++</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> b/src/proto.rs
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">@@</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-304,7 +304,7</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">@@</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> impl NewPacket {
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">} else {
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">let length = u24_le(&amp;*self.header).unwrap();
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">self.last_seq_id = self.header[3];
</span><span style="background-color:#2d2d2d;color:#f2777a;">-</span><span style="background-color:#2d2d2d;color:#f2777a;">                debug!(&quot;Last seq id {}&quot;, self.last_seq_id);
</span><span style="background-color:#2d2d2d;color:#99cc99;">+</span><span style="background-color:#2d2d2d;color:#99cc99;">                //debug!(&quot;Last seq id {}&quot;, self.last_seq_id);
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">self.header.clear();
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">if length == 0 {
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">return ParseResult::Done(Packet { payload: self.data }, self.last_seq_id);
</span></pre>
<p>Take a quick peek at the output below.  When the SSCCE veers off the track, it
runs through 287 more iterations of the parsing loop before the
<code>PacketOutOfOrder</code> error occurs.  That's a whole mess of code I don't have to
step over backwards, and further, I'm now confident I haven't missed some
detail lurking in that mess.  Even better, that <code>needed</code> variable jumps over
1000 consistently.  I can set a conditional breakpoint in GDB to stop when
<code>needed &gt; 1000</code>.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">▶ DSN=mysql://testbot:testbot@192.168.0.162/fake_data RUST_LOG=bug_test_01=debug,mysql_async=debug rr record ./target/release/bug-test-01
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...hundreds of lines needing &lt; 500 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 93 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 105 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 109 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 113 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 80 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 96 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 82 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...and boom!...
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 3420429 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 3350929 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::io: data needs 3350929 bytes
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...284 lines needing &gt; 1000 bytes, and then a problem is detected...
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::conn::futures::read_packet: packet out of order.  found 50, expected 93
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">thread &#39;main&#39; panicked at &#39;error resolving future: Error(PacketOutOfOrder, State { next_error: None, backtrace: None })&#39;, src/libcore/result.rs:859
</span></pre>
<p>I want to take a quick moment to point out a detail I missed.  From the start,
I wanted to determine <em>why the packet out of order error occurs</em>.  But I failed
to notice here that the answer depends on another question: <em>why does the
parser read a header with an invalid length field of 3420429 bytes, yet the
same header contains a sequence ID that was not out of order</em>?  Had I not
missed this detail, I would not later develop suspicions that the Rust
optimizer might contain an obscure bug.</p>
<h2>Enter GDB - Preparation</h2>
<p>Now I'm ready fire up GDB.  It's as simple as <code>rr replay</code> to open the latest
trace in GDB.  On ArchLinux, <em>rr</em> traces are stored in <code>$HOME/.local/share/rr</code>
<del>(I have no idea why they aren't in <code>$HOME/.cache/rr</code> per the <a href="https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html">XDG</a>
spec)</del>  If you want to open an earlier replay, you can use <code>rr replay $HOME/.local/share/rr/&lt;trace dir&gt;</code> to specify a particular trace.</p>
<p>I'm not a fluent reader assembly code, let alone translating assembly back into
Rust.  I wanted GDB to match the assembly with the source code that generated
it.  For that, I must tell GDB where to find my Rust source code and the
<em>mysql_async</em> fork I modified.  I'll let the current working folder of my
project establish where that source code can be found.</p>
<p>Let's make sure I have the Rust source code on my machine.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">▶ rustup component list | grep src
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust-src (installed)
</span></pre>
<p>If <code>rust-src</code> had not appeared, <code>rustup component add rust-src</code> will download
and install the Rust source files.  I highly recommend <em>rustup</em> if you're not
already using it.</p>
<p>Inside GDB, I updated its search path.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">GDB&gt; directory /home/boxofrox/.config/rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">GDB&gt; directory /home/boxofrox/files/development/rust/crates/mysql_async
</span></pre>
<p>There's one small snag, though.  The debugging info in the application binary
says the Rust source code is under a root folder of <code>/checkout</code>.  This is
easily fixed with the <code>substitute-path</code> setting.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">GDB&gt; set substitute-path /checkout/src /src
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">GDB&gt; show substitute-path
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">List of all source path substitution rules:
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#d3d0c8;">`/checkout/src&#39; -&gt; `/src&#39;.
</span></pre>
<p>The last thing I set up was
<a href="https://github.com/cyrus-and/gdb-dashboard">gdb-dashboard</a>.  This amazing
piece of software expands the usability of GDB to new horizons.  Throw in the
<a href="http://pygments.org/">Pygments</a> python library (<code>pip install Pygments</code>), and
GDB starts to rival the fancy IDEs I left behind.</p>
<p>Now with that taken care of, it's time to start debugging.</p>
<h2>Assembly, Out-of-order Execution, and Optimized Variables.  Hoorah.</h2>
<p>The area of code I focused on begins with line 149 in <code>src/io/mod.rs</code> of
<em>mysql_async</em> v0.9.3 as shown below.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">131</span><span style="background-color:#2d2d2d;color:#d3d0c8;">        </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">match</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">132</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Done</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> seq_id</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">133</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Some</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">NewPacket::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">empty</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">parse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">134</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ok</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ready</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Some</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> seq_id</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">135</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">136</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">NeedHeader</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">137</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">138</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">139</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> byte </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">drain</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">cmp::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">min</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">140</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                    new_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">push_header</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">byte</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">141</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">142</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">143</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                    should_poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">true</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">144</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">145</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">146</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                new_packet
</span><span style="background-color:#2d2d2d;color:#f99157;">147</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">149</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#d3d0c8;">debug!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">data needs {} bytes</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">150</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">151</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> byte </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">drain</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">cmp::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">min</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                    new_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">push</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">byte</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">154</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">155</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">156</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                    should_poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">true</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">157</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">158</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">159</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                new_packet
</span><span style="background-color:#2d2d2d;color:#f99157;">160</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">161</span><span style="background-color:#2d2d2d;color:#d3d0c8;">        </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>The first order of business was to set the conditional breakpoint, run the
program, and break execution on line 149.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">GDB&gt; breakpoint src/io/mod.rs:149 if needed &gt; 1000
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">GDB&gt; continue
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:bug_test_01: running
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">DEBUG:mysql_async::proto: Last seq id 0
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Error in testing breakpoint condition:
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">value has been optimized out
</span></pre>
<p><em>Value has been optimized out</em>?!  Curses.  The value that would otherwise have a
permanent residence in some memory location named <code>needed</code> with a debug target,
is now a vagrant wandering between CPU registers and the program stack.  This is
one of the hassles I dealt with.  The other was out-of-order execution.
Converting my source code to machine code in the precise order I wrote the code
doesn't maximize the performance of the CPU.  The compiler will rearrange
instructions so long as the behavior of my program doesn't change, and I can
worry more about my source code making sense while the compiler worries about
the performance aspect.</p>
<p>Due to the optimization error, my breakpoint is no longer conditional, but it
still breaks on line 149.  The assembly below is GDB's AT&amp;T-flavored assembly.
Instructions are written as <code>OPCODE SRC DEST</code>.  If you prefer Intel-flavored
assembly, there's a setting [<a href="http://visualgdb.com/gdbreference/commands/set_disassembly-flavor">1</a>] [<a href="https://sourceware.org/gdb/onlinedocs/gdb/Machine-Code.html">2</a>] for that, too.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">─── Assembly ──────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad5c</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> ja     </span><span style="background-color:#2d2d2d;color:#f99157;">0x56066b1aade5</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll</span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#f99157;">1557</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad62</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbx
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad65</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x168</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad6c</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x1d0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad73</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#f99157;">0xd1306</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rip</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax        </span><span style="background-color:#2d2d2d;color:#d3d0c8;">#</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x56066b27c080</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">core::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">fmt::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">num::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">fmt</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad7a</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x1c8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad81</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#f99157;">0x364df8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rip</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax        </span><span style="background-color:#2d2d2d;color:#d3d0c8;">#</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x56066b50fb80</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#cc99cc;">ref</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.ad</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">─── Source ────────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">144</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 }
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">145</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">146</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 new_packet
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">147</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             }</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">149</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">debug!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">data needs {} bytes</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">150</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">151</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> byte </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">drain</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">cmp::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">min</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     new_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">push</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">byte</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">154</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>I have no idea what that assembly is doing.  Evaluating <code>self</code>, <code>self.buf</code>,
<code>.as_mut()</code>, <code>.unwrap()</code>?  I'll likely never know and half those possibilities
are probably invalid thanks to Rust's zero-cost abstractions, which I am happy
to have.</p>
<p>But let's not get off track.  I need to find where <code>needed</code>'s value is hiding at
this moment in the program.  Around line 149 (o'clock), I should always find it
in the same place.  Let's backtrack to line 148.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> reverse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#d3d0c8;">next
</span><span style="background-color:#2d2d2d;color:#f99157;">149</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">debug!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">data needs {} bytes</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> reverse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#d3d0c8;">next
</span><span style="background-color:#2d2d2d;color:#f99157;">148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">─── Assembly ──────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aace4</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rcx</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x40</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aace8</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r13</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x100</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aace8</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r13</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x100</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aacef</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r12</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0xf8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aacf6</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0xf0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aacfd</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbx</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0xe8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad04</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x58</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad08</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0xe0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad0f</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x68</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad13</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0xd8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad1a</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> movdqa </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x1c0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">xmm0
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad22</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> movdqa </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">xmm0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0xd0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad2a</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r14</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x168</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x000056066b1aad31</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#f99157;">0x38f880</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rip</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax        </span><span style="background-color:#2d2d2d;color:#d3d0c8;">#</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x56066b53a5b8</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">_ZN3log20MAX_LOG_LEVEL_FILTER17he494f5e9534fe154E</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">─── Source ────────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">144</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">145</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">146</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 new_packet
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">147</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             }</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">149</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">debug!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">data needs {} bytes</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">150</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">151</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> byte </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">drain</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">cmp::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">min</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     new_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">push</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">byte</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">154</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre><div class="o-note">
<p>How cool is that!  With <em>rr</em>, you can move forwards or backwards through your
running program on a whim!  GDB provides reverse commands for <code>continue</code>,
<code>next</code>, <code>next-instruction</code>, <code>step</code>, and <code>step-instruction</code>.</p>
<ul>
<li><code>reverse-continue</code> (<code>rc</code>)</li>
<li><code>reverse-next</code> (<code>rn</code>)</li>
<li><code>reverse-next-instruction</code> (<code>rni</code>)</li>
<li><code>reverse-step</code> (<code>rs</code>)</li>
<li><code>reverse-step-instruction</code> (<code>rsi</code>)</li>
</ul>
</div>
<p>Hmmm.  The program counter (PC) jumped backward from 0x---------d6c to
0x---------ce8.  There are quite a few instructions between line 148 and 149.
If I know the first value that <code>needed</code> should have, I might be able to read
the registers or stack locations in that assembly and correlate with that first
value.  According to my packet capture, the first MySQL packet received has a
packet length of 1, and that number is just too common to trust.</p>
<p>As luck would have it, <em>breeden4</em> and <em>kmc</em> on the #rust IRC channel informed
me of <code>test::black_box(var)</code>.  A nice bit of Rust black magic that prevents the
optimizer from touching the <code>var</code> expression inside.  There is some setup
necessary to use it.</p>
<ul>
<li>
<p>Must use nightly toolchain.</p>
</li>
<li>
<p>Import the <em>test</em> crate.  <em>mysql_async</em> already provides this behind the
<code>features = [ nightly ]</code> option.</p>
</li>
<li>
<p>Add <code>use test;</code> at the top of <code>src/io/mod.rs</code>.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#747369;">#[cfg(feature = </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">nightly</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#747369;">)]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#cc99cc;">use</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> test</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre></li>
<li>
<p>Rebuild SSCCE with <code>cargo +nightly build --release</code>.</p>
</li>
<li>
<p>Rerun SSCCE with <code>rr record</code> until error manifests.</p>
</li>
<li>
<p><code>rr replay</code> to jump into GDB and adjust the settings again. <em>(I should really
see about putting the setup in a dot file or something)</em></p>
</li>
</ul>
<p>Modifying <code>src/io/mod.rs</code> pushed the code down, so the breakpoint now resides at
line 152.  I did have to remove my <code>debug!</code> statement so the error would
reappear.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> breakpoint src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbe417</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> file </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> line </span><span style="background-color:#2d2d2d;color:#f99157;">152.</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">continue</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Continuing.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">warning</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> Could not load shared library symbols </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> linux</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#d3d0c8;">vdso.so.</span><span style="background-color:#2d2d2d;color:#f99157;">1.</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Do you need </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">set solib-search-path</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> or </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">set sysroot</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">DEBUG</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;">bug_test_01</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> running
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#f99157;">0x7f9c58e5c590</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>Huh.  I wonder why it stopped at line 153.  The breakpoint must stop after the
line executes.  That's convenient when I want to see the effect of that line of
code.  Not so much now.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> reverse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#d3d0c8;">next
</span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">test::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">black_box</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">─── Assembly ──────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe39b</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r13</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0xc0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> line 151
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3a3</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbx</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0xc8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3ab</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r10</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0xd0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3b3</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r12</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0xd8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3bb</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#f99157;">0x38</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3c0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0xe0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3c8</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#f99157;">0x40</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3cd</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0xe8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3d5</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> movdqa </span><span style="background-color:#2d2d2d;color:#f99157;">0x190</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">xmm0
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3de</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> movdqa </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">xmm0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0xf0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3e7</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r14</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3ef</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax      </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">$rsp</span><span style="background-color:#2d2d2d;color:#747369;">+0x148 holds needed
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3f7</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#f99157;">0x200</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">      </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> test::black_box()
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe3ff</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#f99157;">0x200</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax      </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> rax is never used
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe407</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#f99157;">0xb0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r15</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r12
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe40e</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> test   </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r12</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r12
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe411</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> je     </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbea65</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll</span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#f99157;">3781</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbe417</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#f99157;">0xa0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r15</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax       </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> rax overwritten here
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">─── Source ────────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">150</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             }</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">151</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">test::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">black_box</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">154</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">155</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> byte </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">drain</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">cmp::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">min</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">156</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     new_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">push</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">byte</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">157</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>And here we are.  If I run <code>GDB&gt; x/gu $rax</code>, GDB will show me the 64-bit
unsigned value in that memory location.  That is <code>needed</code>.  <code>$rax</code> won't help me
when it changes on line 153, so I'll use <code>$rsp + 0x148</code> instead.  Now let's set
that breakpoint!  Bear with me, we're going to visit all my mistakes.  Someone
may actually learn something from these examples.</p>
<p><strong>Strike One</strong></p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> disable </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> breakpoint src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">*</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">$rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">1000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Note</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">disabled</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> also set at pc </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbe417</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">2</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbe417</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> file </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> line </span><span style="background-color:#2d2d2d;color:#f99157;">152.</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">continue</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Continuing.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Error </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> testing breakpoint condition</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Attempt to dereference a generic pointer.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">2</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#f99157;">0x7f9c58e5c988</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p><em>Attempt to dereference a generic pointer.</em>  Hmmm.  Guess I need to cast that.
Let's fall back to my old C programming days and make that happen.</p>
<p><strong>Strike Two</strong></p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> get rid of the invalid breakpiong
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> delete </span><span style="background-color:#2d2d2d;color:#f99157;">2</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">break</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">*</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">unsigned long </span><span style="background-color:#2d2d2d;color:#d3d0c8;">*</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">$rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">1000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">syntax error </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> expression</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> near `long </span><span style="background-color:#2d2d2d;color:#d3d0c8;">*</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">$rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">) </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">1000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&#39;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.
</span></pre>
<p>Wait, what?  How does GDB not recognize C syntax??? You mileage will vary here.
I asked on #rust, #archliux, #gdb, and #rr and the syntax worked for some and
not others.  But ultimately, it doesn't work because GDB can parse many
languages and knows it's working with Rust source code.  Rust syntax casting
will work.</p>
<p><strong>Home Run</strong></p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> breakpoint src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">*</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">$rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">as</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#cc99cc;">usize</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">1000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Note</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> breakpoints </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">disabled</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> also set at pc </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbe417</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">3</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbe417</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> file </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> line </span><span style="background-color:#2d2d2d;color:#f99157;">152.</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">continue</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Continuing.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">3</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#f99157;">0x7ffcdf688fa8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> x</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">gu </span><span style="background-color:#2d2d2d;color:#f2777a;">$rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">0x7ffcdf666688</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">6698509</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre><div class="o-note is-pro-tip">
<p>The memory at <code>$rsp + 0x148</code> was loaded with the value in <code>$r14</code>.  I could have
avoided the issues with casting by using <code>if $r14 &gt; 1000</code>, but I felt that
stack memory would be less transient than the registers and more reliable.</p>
</div>
<p>The program has stopped and it looks like <code>needed</code> is 6698509.  Seems a bit high
compared to the numbers I looked at before.   How can I be sure I didn't make a
mistake and stumble upon a garbage value?  Let's enable breakpoint 1 and stop at
line 152 on the previous execution.  There should be a reasonable value there if
I have indeed found <code>needed</code>.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> enable </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> reverse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#cc99cc;">continue</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Continuing.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#f99157;">0x7ffcdf688fa8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> x</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">gu </span><span style="background-color:#2d2d2d;color:#f2777a;">$rsp</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">+</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">0x7ffcdf666688</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">63</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>And 63 is very reasonable.  Looks like I arrived at the correct position in the
program.  I reversed a couple more times; found 62, 61, and 60 as expected;
then continued forward to breakpoint 1 when <code>needed</code> was 63.</p>
<p>From here, I want to step through the program as it parses the bad packet.
Where does that start in the code?  Here is the relevant code in its entirety
with my notes.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;">&gt; src/io/mod.rs
</span><span style="background-color:#2d2d2d;color:#f99157;">101</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#cc99cc;">fn</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#6699cc;">poll</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Poll</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Option</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Packet, </span><span style="background-color:#2d2d2d;color:#cc99cc;">u8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">, Error</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">102</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> should read everything from self.endpoint
</span><span style="background-color:#2d2d2d;color:#f99157;">103</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> would_block </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">false</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">104</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.closed </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">105</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">[</span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#cc99cc;">u8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">4096</span><span style="background-color:#2d2d2d;color:#d3d0c8;">]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Read as many bytes as possible from the network socket
</span><span style="background-color:#2d2d2d;color:#f99157;">106</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#cc99cc;">loop</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">107</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">match</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.endpoint.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">read</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf</span><span style="background-color:#2d2d2d;color:#d3d0c8;">[</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">108</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ok</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Nothing more to read
</span><span style="background-color:#2d2d2d;color:#f99157;">109</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         </span><span style="background-color:#2d2d2d;color:#cc99cc;">break</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">110</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">111</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ok</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">size</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Any bytes read are put in long-term storage (relative to lifetime of a local
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> variable buffer)
</span><span style="background-color:#2d2d2d;color:#f99157;">112</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">113</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">extend</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">buf</span><span style="background-color:#2d2d2d;color:#d3d0c8;">[</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">size</span><span style="background-color:#2d2d2d;color:#d3d0c8;">]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">114</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">115</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Err</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">ref</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> e</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> e.</span><span style="background-color:#2d2d2d;color:#66cccc;">kind</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">ErrorKind::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">WouldBlock </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Nothing more to read.  Let the program keep running instead of blocking.  Yay async.
</span><span style="background-color:#2d2d2d;color:#f99157;">116</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         would_block </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">true</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">117</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         </span><span style="background-color:#2d2d2d;color:#cc99cc;">break</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">118</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">119</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Err</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">error</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">120</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.closed </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">true</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">121</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Err</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Error::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">from</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">error</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">122</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">123</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">124</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">125</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">else</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">126</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ok</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ready</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">None</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">127</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">128</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">129</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> need to call again if there is a data in self.buf
</span><span style="background-color:#2d2d2d;color:#f99157;">130</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> or data was written to packet parser
</span><span style="background-color:#2d2d2d;color:#f99157;">131</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> should_poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">false</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">132</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Regardless whether bytes were read from the network, always try to move
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> parsing further.  There may be some bytes in long-term storage left to use.
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Pick up where the parsing left off last time.  This establishes a state
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> machine when parsing is interrupted by lack of data from the network.
</span><span style="background-color:#2d2d2d;color:#f99157;">133</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.next_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">take</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">expect</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">Stream.next_packet should not be None</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Either finish a packet, or copy bytes from long-term storage into `next_packet`.
</span><span style="background-color:#2d2d2d;color:#f99157;">134</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">match</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">135</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Done</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> seq_id</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Packet is complete.  Set up to parse the next packet before returning the completed packet.
</span><span style="background-color:#2d2d2d;color:#f99157;">136</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Some</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">NewPacket::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">empty</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">parse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">137</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ok</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ready</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Some</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> seq_id</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">138</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">139</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">NeedHeader</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Parsing the header is in progress.  `needed` tells us how many more bytes are
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> needed to finish the header.  It&#39;s never much as the header is four bytes in
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> size.
</span><span style="background-color:#2d2d2d;color:#f99157;">140</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">141</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Copy the needed bytes from long-term storage, or what&#39;s available if supply
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> is short.
</span><span style="background-color:#2d2d2d;color:#f99157;">142</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> byte </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">drain</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">cmp::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">min</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">143</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     new_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">push_header</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">byte</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">144</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">145</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Plan to recurse `poll()` if there are more bytes in long-term storage.
</span><span style="background-color:#2d2d2d;color:#f99157;">146</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     should_poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">true</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">147</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">148</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">149</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 new_packet
</span><span style="background-color:#2d2d2d;color:#f99157;">150</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">151</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> new_packet</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Collecting the data determined by the length field in the header.
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> `needed` tells us how many more bytes are needed.
</span><span style="background-color:#2d2d2d;color:#f99157;">152</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">test::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">black_box</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">153</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">154</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">155</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">for</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> byte </span><span style="background-color:#2d2d2d;color:#d3d0c8;">in</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">drain</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">cmp::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">min</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">156</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     new_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">push</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">byte</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">157</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">158</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_len </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Plan to recurse `poll()` if there are more bytes in long-term storage.
</span><span style="background-color:#2d2d2d;color:#f99157;">159</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     should_poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">true</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">160</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">161</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">162</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 new_packet
</span><span style="background-color:#2d2d2d;color:#f99157;">163</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">164</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">165</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Regardless whether bytes were copied into `next_packet`, try to parse any
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> bytes that were copied and arrange for the next loop iteration to pick up where
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> this leaves off.  `parse()` source code provided below.
</span><span style="background-color:#2d2d2d;color:#f99157;">166</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.next_packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Some</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">next_packet.</span><span style="background-color:#2d2d2d;color:#66cccc;">parse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">167</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Recurse if planned, or there&#39;s a possibility to read more bytes from the
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> network socket.
</span><span style="background-color:#2d2d2d;color:#f99157;">168</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> should_poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">would_block </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">169</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">poll</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">170</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">else</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">171</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Ok</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">NotReady</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">172</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;">&gt; /src/proto.rs
</span><span style="background-color:#2d2d2d;color:#f99157;">271</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#747369;">#[derive(Debug)]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">272</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">pub</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">struct</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">NewPacket</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">273     </span><span style="background-color:#2d2d2d;color:#f2777a;">data</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Vec</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#cc99cc;">u8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">274     </span><span style="background-color:#2d2d2d;color:#f2777a;">length</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">usize</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">275     </span><span style="background-color:#2d2d2d;color:#f2777a;">header</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">Vec</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&lt;</span><span style="background-color:#2d2d2d;color:#cc99cc;">u8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">276     </span><span style="background-color:#2d2d2d;color:#f2777a;">last_seq_id</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">u8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">277 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">278</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">279</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">impl</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">NewPacket</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">...</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">298</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#cc99cc;">pub</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">fn</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#6699cc;">parse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#cc99cc;">mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> ParseResult</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> No idea what this does.  If more data exists than MAX_PAYLOAD_LEN, is it
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> discarded?
</span><span style="background-color:#2d2d2d;color:#f99157;">299</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> last_packet_part </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.data.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">consts::</span><span style="background-color:#2d2d2d;color:#f99157;">MAX_PAYLOAD_LEN</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">300</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> last_packet_part </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> No data exists, run through the parsing checklist.
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Do we have all the bytes for the header?
</span><span style="background-color:#2d2d2d;color:#f99157;">301</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.header.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">4</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">302</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">4</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.header.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Plan to parse the header when all bytes are available.
</span><span style="background-color:#2d2d2d;color:#f99157;">303</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">NeedHeader</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> needed</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">304</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">else</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> All the bytes for the header arrived.  Decompose into packet length and
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> sequence ID.
</span><span style="background-color:#2d2d2d;color:#f99157;">305</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#66cccc;">u24_le</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">*</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.header</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">306</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.last_seq_id </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.header</span><span style="background-color:#2d2d2d;color:#d3d0c8;">[</span><span style="background-color:#2d2d2d;color:#f99157;">3</span><span style="background-color:#2d2d2d;color:#d3d0c8;">]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">307</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;">debug!(&quot;Last seq id {}&quot;, self.last_seq_id);
</span><span style="background-color:#2d2d2d;color:#f99157;">308</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.header.</span><span style="background-color:#2d2d2d;color:#66cccc;">clear</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">309</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Plan to complete packet on the next iteration.
</span><span style="background-color:#2d2d2d;color:#f99157;">310</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Done</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> payload</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.data </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.last_seq_id</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">311</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">else</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">312</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">as</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">usize</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Plan to read more bytes for data on the next iteration.
</span><span style="background-color:#2d2d2d;color:#f99157;">313</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">as</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">usize</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">314</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">315</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">316</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">else</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> Fast path?  Waiting for all the data bytes to arrive.
</span><span style="background-color:#2d2d2d;color:#f99157;">317</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> last_packet_part </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">318</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Done</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Packet </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> payload</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.data </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.last_seq_id</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">319</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">else</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">320</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.length</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">321</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">return</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ParseResult::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Incomplete</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> last_packet_part</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">322</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">323</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">324</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">325</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>So here's my plan.</p>
<ol>
<li>Jump forward to <code>src/io/mod.rs:140</code> when the broken packet starts getting
parsed, then</li>
<li>Jump backward to the top of the <code>poll</code> function.</li>
<li>Observe how many bytes are going into long-term storage <code>self.buf</code>, and</li>
<li>Observe how many bytes are available in <code>self.buf</code>, after reading from the
network stops.</li>
<li>Observe how many bytes are copied into <code>next_packet</code>.  Maybe also verify
that the bytes read from <code>self.buf</code> were written to <code>next_packet</code> instead
of garbage.</li>
<li>Observe the behavior and result of <code>next_packet.parse()</code>.</li>
<li>Repeat 3-6 until anomaly is found.</li>
</ol>
<p>The first two steps are simple enough.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> breakpoint src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">140</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">4</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbe10f</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> file </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> line </span><span style="background-color:#2d2d2d;color:#f99157;">140.</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">continue</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Continuing.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">4</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#f99157;">0x7ffcdf688fa8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">140</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">140</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                     </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> breakpoint src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">101</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">5</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#f99157;">0x562330bbdbbb</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> file </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> line </span><span style="background-color:#2d2d2d;color:#f99157;">101.</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">GDB</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> reverse</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#cc99cc;">continue</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Continuing.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">Breakpoint </span><span style="background-color:#2d2d2d;color:#f99157;">5</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">::</span><span style="background-color:#2d2d2d;color:#d3d0c8;">poll </span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#f99157;">0x7ffcdf688fa8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> at </span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">home</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">boxofrox</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">files</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">development</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rust</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">crates</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">mysql_async</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">src</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#d3d0c8;">io</span><span style="background-color:#2d2d2d;color:#d3d0c8;">/</span><span style="background-color:#2d2d2d;color:#cc99cc;">mod</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.rs</span><span style="background-color:#2d2d2d;color:#d3d0c8;">:</span><span style="background-color:#2d2d2d;color:#f99157;">104</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">104</span><span style="background-color:#2d2d2d;color:#d3d0c8;">             </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">!</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.closed </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>The remaining steps require quite a bit of work.  Not only are the variables
optimized away, but they are complex types (i.e. structs).  Rust <a href="https://github.com/rust-lang/rfcs/blob/master/text/0079-undefined-struct-layout.md">RFC
79</a>
intentionally leaves memory layout unspecified for structs and enums for
optimizations.  In <a href="https://blog.rust-lang.org/2017/06/08/Rust-1.18.html">Rust
1.18</a>, the reorder
optimization went live.  I spent quite a bit of time trying to figure out how to
identity what memory layout the compiler used.  Turns out, <code>rustc -Z print-type-sizes</code> will print the memory layout as well as the sizes.  There's
quite a bit of information to sift through, so I ran the following to dump all
the information relevant to the SSCCE into a file I could search.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">RUSTFLAGS</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">-Z print-type-sizes</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> cargo +nightly build --release </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> /tmp/boxofrox/</span><span style="background-color:#2d2d2d;color:#cc99cc;">type</span><span style="background-color:#2d2d2d;color:#d3d0c8;">-sizes.txt
</span></pre>
<p>Also turns out, that memory layout is only useful when a struct is kept in
memory (like in a unoptimized variable), which isn't the case here.  LLVM will
tear structs apart to optimize the fields individually.  Great for performance.
Not so great for debugging.</p>
<p>So what does one do in this situation?  <code>test::black_box()</code> would work if I
weren't pushing the limits with my first use of it.  Add more and the error no
longer occurs.  Stack offsets (e.g. <code>$rsp + 0x148</code>) seem to vary wildly from
build to build, so I can't move <code>test::black_box()</code> around to identify each
field at a time.</p>
<p>I adopted another technique I would call a choke-point method.  Basically, I
paw through the code looking for simple expressions that use or assign to the
variable I'm interested in, then cross my fingers and pray that expression
wasn't optimized away.</p>
<div class="o-note is-note">
<p>An rvalue assignment is only a viable choke point when backtracking through the
code.  The compiler doesn't care where a value was stored on the stack earlier
and may assign the value to a new stack location.  So finding an rvalue
assignment after your &quot;instruction of interest&quot; may present you with the wrong
stack location.</p>
</div>
<p>So how did I apply this method?  Recall that I wanted to observe the number of
bytes in <code>self.buf</code> as step 3 of my plan.  First, I characterize the variable
type so I know what part(s) I'm looking for.  <code>self.buf</code> is a
<code>std::collections::VecDeque&lt;u8&gt;</code>, which is composed of other types. After
digging through the rust source a bit, it breaks down into:</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">⎧ tail : usize
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">VecDeque&lt;T&gt; ⎨ head : usize     ⎧ ptr : Unique&lt;T&gt;    { pointer : NonZero&lt;*const T&gt;
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">⎩ buf  : RawVec&lt;T&gt; ⎨ cap : usize
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                               </span><span style="background-color:#2d2d2d;color:#d3d0c8;">⎩ a   : Alloc = Heap
</span></pre>
<p>Or more simply:</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">⎧ tail : usize
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">VecDeque&lt;T&gt; ⎨ head : usize
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">⎪ ptr  : *T
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">            </span><span style="background-color:#2d2d2d;color:#d3d0c8;">⎩ cap  : usize
</span></pre>
<p>In the snippet below, line 112 looks like it would simplify to one or two
instructions and provide a starting address for <code>self.buf</code>, but <code>buf_handle</code> is
a temporary variable and was optimized away.  Line 113 references two
variables, so I don't know exactly which assembly opcodes pertain to which
variable.  Instead, I tried drilling down into that call to <code>VecDeque::extend</code>
since it receives <code>self.buf</code> and interacts with the <code>VecDeque</code> data.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#f99157;">112</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         </span><span style="background-color:#2d2d2d;color:#cc99cc;">let</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> buf_handle </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.buf.</span><span style="background-color:#2d2d2d;color:#66cccc;">as_mut</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">unwrap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">113</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                         buf_handle.</span><span style="background-color:#2d2d2d;color:#66cccc;">extend</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">buf</span><span style="background-color:#2d2d2d;color:#d3d0c8;">[</span><span style="background-color:#2d2d2d;color:#d3d0c8;">..</span><span style="background-color:#2d2d2d;color:#d3d0c8;">size</span><span style="background-color:#2d2d2d;color:#d3d0c8;">]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>Eventually, I ran into the private function <code>VecDeque::is_full()</code>:</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">─── Assembly ──────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc75</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#f99157;">0xa8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r15</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rdx
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc7c</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#f99157;">0xb8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r15</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbx
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc83</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rdx</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc86</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> sub    </span><span style="background-color:#2d2d2d;color:#f99157;">0xa0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">r15</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc8d</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> lea    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#f99157;">0x1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbx</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rcx
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc91</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> and    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rcx
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc94</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> mov    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rbx</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">|</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc97</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> sub    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rcx</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc9a</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">?</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> cmp    </span><span style="background-color:#2d2d2d;color:#d3d0c8;">$</span><span style="background-color:#2d2d2d;color:#f99157;">0x1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;">%</span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">─── Source ────────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">139</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#747369;">///</span><span style="background-color:#2d2d2d;color:#747369;"> Returns `true` if and only if the buffer is at full capacity.
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">140</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#747369;">#[inline]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">141</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#cc99cc;">fn</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#6699cc;">is_full</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">bool</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">142</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">cap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">143</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#d3d0c8;">...</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">791</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#747369;">#[stable(feature = </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">rust1</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#747369;">, since = </span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#99cc99;">1.0.0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&quot;</span><span style="background-color:#2d2d2d;color:#747369;">)]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">792</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#cc99cc;">pub</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">fn</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#6699cc;">len</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">&amp;</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">-&gt;</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#cc99cc;">usize</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">793</span><span style="background-color:#2d2d2d;color:#d3d0c8;">         </span><span style="background-color:#2d2d2d;color:#66cccc;">count</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.tail</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.head</span><span style="background-color:#2d2d2d;color:#d3d0c8;">,</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.</span><span style="background-color:#2d2d2d;color:#66cccc;">cap</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#f99157;">794</span><span style="background-color:#2d2d2d;color:#d3d0c8;">     </span><span style="background-color:#2d2d2d;color:#d3d0c8;">}</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">─── Registers ─────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#d3d0c8;">rax </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000000000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       rbx </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000080000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       rcx </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000000000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       rdx </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000000000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#d3d0c8;">rsi </span><span style="background-color:#2d2d2d;color:#f99157;">0x00007ffcdf6679a0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       rdi </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000000006</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       rbp </span><span style="background-color:#2d2d2d;color:#f99157;">0x00007ffcdf668a00</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       rsp </span><span style="background-color:#2d2d2d;color:#f99157;">0x00007ffcdf6677a0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">   </span><span style="background-color:#2d2d2d;color:#d3d0c8;">r8 </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000000000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">        r9 </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000000000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       r10 </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000000000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       r11 </span><span style="background-color:#2d2d2d;color:#f99157;">0x000000000000002d</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#d3d0c8;">r12 </span><span style="background-color:#2d2d2d;color:#f99157;">0x00007ffcdf6679a0</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       r13 </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000000000001000</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       r14 </span><span style="background-color:#2d2d2d;color:#f99157;">0x000000000000000d</span><span style="background-color:#2d2d2d;color:#d3d0c8;">       r15 </span><span style="background-color:#2d2d2d;color:#f99157;">0x00007ffcdf688fa8</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">  </span><span style="background-color:#2d2d2d;color:#d3d0c8;">rip </span><span style="background-color:#2d2d2d;color:#f99157;">0x0000562330bbdc94</span><span style="background-color:#2d2d2d;color:#d3d0c8;">    eflags </span><span style="background-color:#2d2d2d;color:#d3d0c8;">[</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">PF</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">ZF</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">IF</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">]</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>According to this assembly, <code>$rax - $rcx</code> is equivalent to <code>self.cap() - self.len()</code>.  Tracing backward, I found that <code>$r15 + 0xb8</code> holds <code>self.cap()</code> at
address <code>0x77ffcdf688fa8 + 0xb8</code> and <code>self.len()</code> is computed from <code>self.head - self.tail</code>, and that correlates to <code>($r15 + 0xa8) - ($r15 + 0xa0)</code> in the
assembly above.  If I look at a hex-dump of the 32 bytes at the <code>$r15 + 0xa0</code>
address, I find a layout similar to the <code>VecDeque</code> characterization I created
earlier.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#d3d0c8;">─── Memory ──────────────────────────────────────────────────────────────────────────
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">0x00007ffcdf689048 00 00 00 00 00 00 00 00   00 00 00 00 00 00 00 00 ................
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                   </span><span style="background-color:#2d2d2d;color:#d3d0c8;">tail                      head
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">0x00007ffcdf689058 00 61 f0 58 9c 7f 00 00   00 00 08 00 00 00 00 00 .a.X............
</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                   </span><span style="background-color:#2d2d2d;color:#d3d0c8;">ptr ??                    cap
</span></pre>
<p>At this point, I wasn't sure I found <code>ptr</code>, but since the code is in the
process of extending an empty (<code>head = tail = 0</code>) <code>VecDeque</code> with bytes, I can
watch the 0x80000 bytes at <code>0x7f9c58f06100</code> and see that they fill with bytes
as I step through the rest of the process.  I also noted that <code>ptr</code> is subject
to change when the buffer grows, so whenever I wanted to watch the memory for
<code>self.buf</code>, I had to keep track of when <code>ptr</code> changed.</p>
<p>With this method in hand, I ran through my plan, paraphrasing each line of code
until I had a story that made sense up until the glitch occurred.</p>
<h2>A Story of an Anomaly in the Machine</h2>
<p>At the time the application flakes out, the <em>mysql_async</em> library has read the
<strong>last four bytes</strong> retrieved from the <code>tokio_core::net::TcpStream</code> into an
<strong>empty</strong> intermediate data structure <code>mysql_async::proto::NewPacket</code>, called
<code>new_packet</code>, that is used to parse one MySQL packet as bytes become available.
These last four bytes are the 4-byte header of the next MySQL packet to parse
and they are copied into the <code>new_packet.header</code>, a <code>std::vec::Vec</code> (assertion
<code>new_packet.header.len() == 4</code>), then decomposed into an 8-bit sequence ID and
a 24-bit unsigned length.</p>
<p>Now that the MySQL header is read, the length indicates that 115 more bytes of
data are needed to complete the packet. Since there are no more bytes to
process, another attempt to read from <code>TcpStream</code> commences, and fails with
<code>Err(WouldBlock)</code>, at which point the <em>mysql_async</em> library schedules a future
read, then tries to reparse <code>new_packet</code> <strong>just one more time</strong> in case some
bytes had been read.</p>
<p>The <code>new_packet.parse()</code> function (in <code>src/proto.rs</code> line 298) is a state
machine transitioner that checks the current state, and with its return value,
schedules where the next bytes read from the <code>TcpStream</code> shall go when put into
<code>new_packet</code>. The program already pulled four bytes for the header, the buffer
was empty, and there are no more bytes to be had at this point. When the parse
function checks to see if the header has all its bytes, it's here that the
register--that represents <code>new_packet.header.len()</code>--contains 0x00 instead of
0x04. The code erroneously returns a <code>ParseResult::NeedHeader</code> instead of
<code>ParseResult::IncompleteData</code>, which corrupts further reading of the
<code>TcpStream</code>.</p>
<p>Anomaly is found.  And, damn, does the program have to run fast to trigger it.</p>
<h2>The Fix I Had Not Found</h2>
<p>By the time I got this far, I had spent hours over three weeks digging through
the program and was so burnt out I couldn't see the forest through the trees.</p>
<p>Before I could spend hours more working backwards from the anomaly trying to
understand why that register for <code>new_packet.header.len()</code> reset to zero,
<em>@inejge</em> pointed out the culprit for me [<a href="https://github.com/rust-lang/rust/issues/42610#issuecomment-309295576">4</a>] and saved the day.  Turns out,
line 308 in <code>src/proto.rs</code> was clearing out the contents of the
<code>new_packet.header</code> vector.</p>
<pre style="background-color:#2d2d2d">
<span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;"> src/proto.rs
</span><span style="background-color:#2d2d2d;color:#f99157;">307</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#747369;">//</span><span style="background-color:#2d2d2d;color:#747369;">debug!(&quot;Last seq id {}&quot;, self.last_seq_id);
</span><span style="background-color:#2d2d2d;color:#f99157;">308</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#f2777a;">self</span><span style="background-color:#2d2d2d;color:#d3d0c8;">.header.</span><span style="background-color:#2d2d2d;color:#66cccc;">clear</span><span style="background-color:#2d2d2d;color:#d3d0c8;">(</span><span style="background-color:#2d2d2d;color:#d3d0c8;">)</span><span style="background-color:#2d2d2d;color:#d3d0c8;">;</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span><span style="background-color:#2d2d2d;color:#f99157;">309</span><span style="background-color:#2d2d2d;color:#d3d0c8;">                 </span><span style="background-color:#2d2d2d;color:#cc99cc;">if</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> length </span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;">=</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#f99157;">0</span><span style="background-color:#2d2d2d;color:#d3d0c8;"> </span><span style="background-color:#2d2d2d;color:#d3d0c8;">{</span><span style="background-color:#2d2d2d;color:#d3d0c8;">
</span></pre>
<p>Oh, let me count the number of times I looked at that line of code as I stepped
through the program again and again, teasing out stack locations for optimized
variables, and not once did my mind register that line even existed.</p>
<p>I submitted a <a href="https://github.com/blackbeam/mysql_async/pull/11">pull request</a> to remove line 308, which was accepted and
<em>mysql_async</em> runs all the better for it.</p>
<h2>Some Lessons Learned and Other Wisdom</h2>
<ol>
<li>Attention to detail is key.</li>
<li>Analyze from different perspectives to correlate results and verify
conclusions are accurate.</li>
<li>Never underestimate the utility of a second [or third] pair of eyes.</li>
<li>Always question your assumptions, sometimes when you think you got them
right, they're wrong.</li>
<li>Keep your anger and frustration in check.  When asking for assistance, a
negative tone is less inviting to a volunteer.  It's easy to misdirect
anger at the person trying to help, and volunteers neither want nor deserve
that.  Make an effort, at the very least, to keep a neutral tone.</li>
<li>You can't share a <em>rr</em> trace with others.  It's tied directly to your
hardware and OS, due to the syscall recording.  Efforts are underway to
lift this limitation, though.</li>
<li>Just because you're programming with Rust doesn't mean your code won't
suffer from wierd behavior.</li>
</ol>
<h2>Conclusion</h2>
<p>This bug was a great opportunity to learn the grittier side of debugging.  The
unfortunate aspect was that stumbling over the &quot;things I didn't know&quot; was a
huge time sink when I could barely afford it.  The next time I run into a
similar problem, I'll be better equipped to handle the case.</p>
<p>Many thanks to @inejge, @Mark-Simulacrum for their assistance troubleshooting
this bug.  I offered @inejge a tip for a cup of coffee (or some such) for
finding the solution.  Instead he asked that I write this blog post.  You can
thank him for all this 😜.</p>
<p>My thanks also goes out to all the Rust devs and community, Tokio devs, and
especially @blackbeam for his work maintaining <em>mysql_async</em>.</p>

  </section>
</article>

        
      </main>
      <footer class="c-footer">
        <div class="u-text--center"><small>
          Copyright &copy; 2017 - Justin Charette (boxofrox)
        </small></div>
        <div class="u-text--center"><small>
          Powered by
          <a href="https://github.com/cobalt-org/cobalt.rs">cobalt.rs</a>
        </small></div>
      </footer>
    </div>
  </body>
</html>
